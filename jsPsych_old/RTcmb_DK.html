<!DOCTYPE html>
<html>
  <head>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
    <meta content="utf-8" http-equiv="encoding">
    <title>Simple visual reaction time</title>
    <script src="jspsych-6.1.0/jspsych.js"></script>
    <script src="js/utils.js"></script>    
    <script src="jspsych-6.1.0/plugins/jspsych-html-keyboard-response.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-image-keyboard-response.js"></script>
    <script src="js/welcome.js"></script>
    <script src="js/sv_training.js"></script>
    <script src="js/sv_real.js"></script>
    <link href="jspsych-6.1.0/css/jspsych.css" rel="stylesheet" type="text/css"></link>
    <link href="css/RT_DK.css" rel="stylesheet" type="text/css"></link>
  </head>
  <body></body>
  <script>
   // Here is an example of a method which appends a set of properties to every trial in the data object
   // I need to figure out how to automatically set individual subject IDs)
  // jsPsych.data.addProperties({subject: 1, condition: 'control'});
    /* create timeline */
    // var timeline = [];

    // /* define welcome message trial */
    // var welcome = {
    //   type: "html-keyboard-response",
    //   stimulus: "<p>Her kommer en test af din reaktionstid. </p>" +
    //   "<p> Du skal gennemføre tre forskellige opgaver. </p>"+
    //   "<p class='gap-above'><strong><i>Tryk på en tast for at læse instruktionen til den første.</strong></i></p>"
    // };
    // timeline.push(welcome);
    
    /* here I need to randomize presentation of audSRT, visSRT and visCRT 
    ... and change var names accordingly
    
    var test_procedure = {
      timeline: [fixation, test],
      timeline_variables: test_stimuli,
      randomize_order: true,
      repetitions: 5
    }*/

    // /* define instructions trial */
    // var instructions = {
    //   type: "html-keyboard-response",
    //   stimulus: "<p>I den følgende opgave vil du se en hvid kasse på skærmen.</p>" +          
    //       "<div style='width: 900px;'>"+
    //         "<div class='instr-img'>" + 
    //           "<img src='img/blankbox.png'></img>" +
    //           "<p class='small'><strong>Vent!</strong></p>" + 
    //         "</div>" +
    //         "<p> Hver gang du ser et <strong>kryds</strong> i kassen, " +
    //         "skal du trykke på <strong>mellemrumstasten,</strong> så hurtigt som du kan.</p>" +
    //         "<div class='instr-img'>" + 
    //           "<img src='img/cross.png'></img>" +
    //           "<p class='small'><strong>Tryk!</strong></p>" +
    //         "</div>" +
    //                "<p> Du får lov til at prøve det nogle gange først.</p>"+
    //       "<p class='gap-above'> <strong><i>Tryk på en tast for at starte træningsrunden.</strong></i></p>",
    //   post_trial_gap: 100
    // };
    
    // timeline.push(instructions);

    // /* test trials */
    // var test_stimuli = [
    //   { stimulus: "img/cross.png", data: {test_part: 'test', correct_response: 'space'}}
    // ];
    //  /* training trials */
    //  var training_stimuli = [
    //   { stimulus: "img/cross.png", data: {test_part: 'training_test', correct_response: 'space'}}
    // ];

    // var fixation = {
    //   type: 'image-keyboard-response',
    //   stimulus: "img/blankbox.png", 
    // //   choices: jsPsych.NO_KEYS,
    //   choices: ['space'],
    //   trial_duration: function(){
    //     return jsPsych.randomization.sampleWithoutReplacement([1000, 1250, 1500, 1750, 2000, 2250, 2500], 1)[0];
    //   },
    //   data:{test_part: 'fixation', correct_response: 'null'},
    //   response_ends_trial: false
    // }

    // var training_fixation = {
    //   type: 'image-keyboard-response',
    //   stimulus: "img/blankbox.png", 
    // //   choices: jsPsych.NO_KEYS,
    //   choices: ['space'],
    //   trial_duration: function(){
    //     return jsPsych.randomization.sampleWithoutReplacement([1000, 1250, 1500, 1750, 2000, 2250, 2500], 1)[0];
    //   },
    //   data:{test_part: 'training_fixation', correct_response: 'null'},
    //   response_ends_trial: false
    // };

    // var test = {
    //   type: "image-keyboard-response",
    //   stimulus: jsPsych.timelineVariable('stimulus'),
    //   choices: ['space'],
    //   trial_duration: 1000,
    //   data: jsPsych.timelineVariable('data'),
    //   on_finish: function(data){
    //       data.correct = data.key_press == jsPsych.pluginAPI.convertKeyCharacterToKeyCode(data.correct_response);
    //   }
    // };

    // var training = {
    //   type: "image-keyboard-response",
    //   stimulus: jsPsych.timelineVariable('stimulus'),
    //   choices: ['space'],
    //   trial_duration: 1000,
    //   data: jsPsych.timelineVariable('data'),
    //   on_finish: function(data){
    //       data.correct = data.key_press == jsPsych.pluginAPI.convertKeyCharacterToKeyCode(data.correct_response)  && data.rt > 100
    //   }
    // };

    // var training_procedure = {
    //   timeline: [training_fixation, training],
    //   timeline_variables: training_stimuli,
    //   randomize_order: true,
    //   repetitions: 10
    // }

    // timeline.push(training_procedure);

    // /* define training debrief */

    // var training_debrief_block = {
    //   type: "html-keyboard-response",
    //   stimulus: function() {

    //     var tr_trials = jsPsych.data.get().filter({test_part: 'training_test'});
    //     var tr_fixations = jsPsych.data.get().filter({test_part: 'training_fixation'});
        
    //     var correct_trials = tr_trials.filter({correct: true});
    //     var incorrect_trials = tr_trials.filter({correct: false})
    //     var false_alarms = tr_fixations.filter({key_press: 32});
        

    //     // count the number of trials with a response time smaller than 100 ms (considered false anticipatory responses).
    //     var too_fast = jsPsych.data.get().filterCustom(
    //       function(tr_trials){
    //         return (tr_trials.test_part== "training_test") && (tr_trials.key_press===32) && (tr_trials.rt < 100);
    //       }
    //     ).count()

    //     // count the number of trials denoted "incorrect" because of response times larger than duration of trial (currently 1000ms).

    //     var too_slow = jsPsych.data.get().filterCustom(
    //       function(incorrect_trials){
    //         return (incorrect_trials.test_part== "training_test") && (incorrect_trials.rt === null);
    //       }
    //     ).count()
        
    //     var too_early = Math.round(too_fast + false_alarms.count());
        
    //     // calculate accuracy (% correct responses)
    //     var tr_accuracy = Math.round(correct_trials.count() / tr_trials.count() * 100);

    //      // calculate proportion of false alarms (responses to fixations)
    //     var tr_falsealarm = Math.round(false_alarms.count() / tr_fixations.count() * 100);
        
    //     // calculate reaction time
    //     var tr_rt = Math.round(correct_trials.select('rt').mean());
        
    //     //count incorrect trials (too slow (>1000 ms) and too fast (0-150 ms))
    //     var no_inc = incorrect_trials.count();

    //     return "<p>Din gennemsnitlige reaktionstid her i træningsrunden var </p>" +
    //            "<p><strong> "+tr_rt+" ms </strong></p>"+
    //            "<p>Du trykkede for tidligt "+too_early+" gange </p>" + 
    //            "</div>" + 
    //            "<p class='gap-above'><strong><i>Tryk på en tast for at fortsætte</strong></i></p>";
    //   },
    //   on_finish: function(data, too_early, too_slow){
    //     // get data
    //     var tr_trials = jsPsych.data.get().filter({test_part: 'training_test'});
    //     var tr_fixations = jsPsych.data.get().filter({test_part: 'training_fixation'});


    //     var tr_correct_trials = tr_trials.filter({correct: true});
    //     var tr_false_alarms = tr_fixations.filter({key_press: 32});
    //     var tr_too_fast = jsPsych.data.get().filterCustom(
    //       function(tr_trials){
    //         return (tr_trials.test_part== "training_test") && (tr_trials.key_press===32) && (tr_trials.rt < 100);
    //       }
    //     ).count()
    //     var tr_too_slow = jsPsych.data.get().filterCustom(
    //       function(incorrect_trials){
    //         return (incorrect_trials.test_part== "training_test") && (incorrect_trials.rt === null);
    //       }
    //     ).count()
    //     var tr_rt = Math.round(tr_correct_trials.select('rt').mean());
    //     var tr_too_early = Math.round(tr_too_fast + tr_false_alarms.count());
    //     var tr_accuracy = Math.round(tr_correct_trials.count() / tr_trials.count() * 100);
    //     var tr_falsealarm = Math.round(tr_false_alarms.count() / tr_fixations.count() * 100);
        
    //     data.summary = {RT: tr_rt, ACC_pct: tr_accuracy, Too_Early: tr_too_early, Too_Slow: tr_too_slow};
    //   } 
    // };
    // timeline.push(training_debrief_block);
    
    // var start_real = {
    //   type: "html-keyboard-response",
    //   stimulus: "<p> Nu kommer den <strong>rigtige test af din reaktionstid</strong>.</p> " +
    //         "<p> Når du ser krydset, skal du trykke så hurtigt som du kan. </p>" +
    //         "<div class='instr-img'>" + 
    //           "     <img src='img/cross.png'></img>" +
              
    //       "<p>Er du klar? Opgaven handler om fart!</p>" + 
    //       "<p class='gap-above'><strong><i>Tryk på en tast for at starte</strong></i></p>",
    //   post_trial_gap: 100
    // };
    // timeline.push(start_real);

    // var test_procedure = {
    //   timeline: [fixation, test],
    //   timeline_variables: test_stimuli,
    //   randomize_order: true,
    //   repetitions: 10
    // }

    // timeline.push(test_procedure);


    /* define debrief */

    // var debrief_block = {
    //   type: "html-keyboard-response",
    //   stimulus: function() {

    //     var trials = jsPsych.data.get().filter({test_part: 'test'});
    //     var fixations = jsPsych.data.get().filter({test_part: 'fixation'});
        
    //     var correct_trials = trials.filter({correct: true});
    //     var incorrect_trials = fixations.filter({key_press: 32});
       
    //     // count the number of trials with a response time smaller than 200 ms.
    //     var too_fast = jsPsych.data.get().filterCustom(function(correct_trials){
    //     return (correct_trials.test_part=== "test") && (correct_trials.key_press===32) && (correct_trials.rt < 100) ;}).count()


    //     var accuracy = Math.round(correct_trials.count() / trials.count() * 100);
    //     var falsealarm = Math.round(incorrect_trials.count() / fixations.count() * 100);
    //     var rt = Math.round(correct_trials.select('rt').mean());

    //     return "<p>"+too_fast+"Du trykkede for hurtigt "+falsealarm+" % af gangene. Du svarede korrekt  "+accuracy+"% af gangene.</p>"+
    //     "<p>Din gennemsnitlige reaktionstid var"+rt+"ms.</p>"+
    //     "<p>Tryk på en tast for at afslutte den visuelle reaktionstidstest. Tak!</p>";

    //   }
    // };
    // // timeline.push(debrief_block);
    // var debrief_block = {
    //   type: "html-keyboard-response",
    //   stimulus: function() {

    //     var trials = jsPsych.data.get().filter({test_part: 'test'});
    //     var fixations = jsPsych.data.get().filter({test_part: 'fixation'});
        
    //     var correct_trials = trials.filter({correct: true});
    //     var incorrect_trials = trials.filter({correct: false})
    //     var false_alarms = fixations.filter({key_press: 32});
        

    //     // count the number of trials with a response time smaller than 100 ms (considered false anticipatory responses).
    //     var too_fast = jsPsych.data.get().filterCustom(
    //       function(trials){
    //         return (trials.test_part== "test") && (trials.key_press===32) && (trials.rt < 100);
    //       }
    //     ).count()

    //     // count the number of trials denoted "incorrect" because of response times larger than duration (currently 1000ms).

    //     var too_slow = jsPsych.data.get().filterCustom(
    //       function(incorrect_trials){
    //         return (incorrect_trials.test_part== "test") && (incorrect_trials.rt === null);
    //       }
    //     ).count()
        
    //     var too_early = Math.round(too_fast + false_alarms.count());
        
    //     // calculate accuracy (% correct responses)
    //     var accuracy = Math.round(correct_trials.count() / trials.count() * 100);

    //      // calculate proportion of false alarms (responses to fixations)
    //     var falsealarm = Math.round(false_alarms.count() / fixations.count() * 100);
        
    //     // calculate reaction time
    //     var rt = Math.round(correct_trials.select('rt').mean());
        
    //     //count incorrect trials (too slow (>1000 ms) and too fast (0-150 ms))
    //     var no_inc = incorrect_trials.count();

    //     return "<p>Din gennemsnitlige reaktionstid var </p>" +
    //            "<p><strong> "+rt+" ms </strong></p>"+
    //            "<p>Du trykkede for tidligt "+too_early+" gange </p>" + 
    //            "</div>" + 
    //            "<p class='gap-above'><strong><i>Tryk på en tast for at afslutte denne test</strong></i></p>";
    //   },
    //   on_finish: function(data, too_early, too_slow){
    //     // get data
    //     var trials = jsPsych.data.get().filter({test_part: 'test'});
    //     var fixations = jsPsych.data.get().filter({test_part: 'fixation'});


    //     var correct_trials = trials.filter({correct: true});
    //     var false_alarms = fixations.filter({key_press: 32});
    //     var too_fast = jsPsych.data.get().filterCustom(
    //       function(trials){
    //         return (trials.test_part== "test") && (trials.key_press===32) && (trials.rt < 100);
    //       }
    //     ).count()
    //     var too_slow = jsPsych.data.get().filterCustom(
    //       function(incorrect_trials){
    //         return (incorrect_trials.test_part== "test") && (incorrect_trials.rt === null);
    //       }
    //     ).count()
    //     var rt = Math.round(correct_trials.select('rt').mean());
    //     var too_early = Math.round(too_fast + false_alarms.count());
    //     var accuracy = Math.round(correct_trials.count() / trials.count() * 100);
    //     var falsealarm = Math.round(false_alarms.count() / fixations.count() * 100);
        
    //     data.summary = {RT: rt, ACC_pct: accuracy, Too_Early: too_early, Too_Slow: too_slow};
    //   } 
    // };
    // timeline.push(debrief_block);

     /* start the experiment */
     jsPsych.init({
      timeline: timeline,
      on_finish: function() {
        jsPsych.data.displayData();
      }
    });
  </script>
  </html>